<!doctype html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Test sending of html-messages to FrACT₁₀</title>
	</head>
	<body>

	<h1>Test sending of HTML Messages to FrACT₁₀</h1>
    <iframe id="fractFrame" src="index.html" scrolling="yes" allow="clipboard-write" style="width: 800px; height: 628px; border: 1px solid #3050C0; padding:0px; margin:0px;"></iframe>
	<br>

	<label for="messageStringField">Return messages:</label><br>
	<textarea id="messageStringField" rows="10" cols="103" style="overflow: scroll;"></textarea>
	<br>

    <script>
	   'use strict';
	   const YES = true, NO = !YES;
	   function tellIframe(message) {
		   document.getElementById("messageStringField").value = ""; // clear
		   const iframe = document.getElementById('fractFrame');
		   iframe.contentWindow.postMessage(message, "*");
	   }
	   function runDemoWith3trials() {
		   tellIframe({m1: 'setSetting', m2: 'Preset', m3: 'Demo'});
		   tellIframe({m1: 'setSetting', m2: 'nTrials08', m3: 3});
		   tellIframe({m1: 'Run', m2: 'Acuity', m3: 'Letters'});
	   }


	   // Send a message to the iframe and return a promise
	   function tellIframeReturningPromise(message, timeout = 1000) {
		 return new Promise((resolve, reject) => {
		   const iframe = document.getElementById('fractFrame');
		   const messageListener = (event) => { // Create a message listener
			 if (event.source === iframe.contentWindow) {
			   window.removeEventListener('message', messageListener);
			   if (event.data.error) {
			     reject(new Error(event.data.error));
			   } else {
			     resolve(event.data);
			   }
			 }
		   };
		   window.addEventListener('message', messageListener);
		   iframe.contentWindow.postMessage(message, '*');
		   setTimeout(() => { // Set a timeout to reject the promise if no response is received
			 window.removeEventListener('message', messageListener);
			 reject(new Error('Timeout: No response from iframe within ' + timeout + "ms."));
		   }, timeout); // timeout in ms
		 });
	   }


	   async function sendAsyncMessageChain01() {
		   let response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'distanceInCM', m3: ''});
		   if (!response.success) return;
		   const distanceInCM = response.m3;
		   response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'distanceInCM', m3: 400});
		   if (!response.success) return; // these many success tests may be an overkill…

		   response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'calBarLengthInMM', m3: ''});
		   if (!response.success) return;
		   const calBarLengthInMM = response.m3;
		   response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'calBarLengthInMM', m3: 170});
		   if (!response.success) return;

		   response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'nTrials08', m3: ''});
		   if (!response.success) return;
		   const nTrials08 = response.m3;
		   response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'nTrials08', m3: 12});
		   if (!response.success) return;

		   response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'responseInfoAtStart', m3: ''});
		   if (!response.success) return;
		   const responseInfoAtStart = response.m3;
		   response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'responseInfoAtStart', m3: 0});
		   if (!response.success) return;

		   response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'autoRunIndex', m3: ''});
		   if (!response.success) return;
		   const autoRunIndex = response.m3;
		   response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'autoRunIndex', m3: 2});
		   if (!response.success) return;

		   response = await tellIframeReturningPromise({m1: 'Run', m2: 'Acuity', m3: 'Letters'}, 20000);
		   //if (!response.success) return; in case of error we also want to restore

		   // restore settings
		   response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'distanceInCM', m3: distanceInCM});
		   response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'calBarLengthInMM', m3: calBarLengthInMM});
   		   response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'nTrials08', m3: nTrials08});
		   response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'responseInfoAtStart', m3: responseInfoAtStart});
		   response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'autoRunIndex', m3: autoRunIndex});

		   console.info("sucessfully ran and restored.");
		}


		async function runResponding() {
			let response, rChar;
			response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'Preset', m3: 'Testing'});
			tellIframe({m1: 'Run', m2: 'Acuity', m3: 'LandoltC'});
			while (YES) {
				response = await tellIframeReturningPromise({m1: 'getValue', m2: 'iTrial', m3: ''});
				if (!response.success) return; // when run done, iTrial==0 & no success
				response = await tellIframeReturningPromise({m1: 'getValue', m2: 'currentAlternative', m3: ''});
				if (!response.success) return;
				switch (response.m3) {
					case 7: rChar = "3";  break;
					case 6: rChar = "2";  break; // ↓
					case 5: rChar = "1";  break;
					case 4: rChar = "4";  break; // ←
					case 3: rChar = "7";  break;
					case 2: rChar = "8";  break; // ↑
					case 1: rChar = "9";  break;
					default: rChar = "6"; // 0, angle 0°: →
				}
				await pauseMilliseconds(100); // otherwise blindingly fast
				response = await tellIframeReturningPromise({m1: 'respondWithChar', m2: rChar, m3: ''});
				if (!response.success) return;
			}
		}


		function pauseMilliseconds(ms) {
		    return new Promise(resolve => setTimeout(resolve, ms));
		}


		window.addEventListener('message', function(e) {
			//console.info('TESTER received message: ', e.data);
			const tf = document.getElementById("messageStringField");
			tf.value += "\n" + "success: " + e.data.success + ", m1: " + e.data.m1 + ", m2: " + e.data.m2;
			tf.value += ", m3: " + e.data.m3;
			tf.scrollTop = tf.scrollHeight;
		});


		async function testAll() {//		console.info("testAll");
 		    let response;  const pauseMS = 300;
			await pauseMilliseconds(500);

			response = await tellIframeReturningPromise({m1: '', m2: '', m3: ''});//well formed, but unknown message
		    if (response.success) errorAlert();

			await pauseMilliseconds(pauseMS);
			response = await tellIframeReturningPromise({m1: 'getVersion', m2: '', m3: ''});
		    if (!response.success) errorAlert();

			await pauseMilliseconds(pauseMS);
		    response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'Preset', m3: 'Standard Defaults'});
		    if (!response.success) errorAlert();
		    response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'distanceInCM', m3: ''});
		    if (!response.success) errorAlert();
		    if (response.m3 != 399) errorAlert();

			await pauseMilliseconds(pauseMS);
		    response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'Preset', m3: 'Testing'});
		    if (!response.success) errorAlert();
		    response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'distanceInCM', m3: ''});
		    if (!response.success) errorAlert();
		    if (response.m3 != 400) errorAlert(); // did we really switch to Testing?

			await pauseMilliseconds(pauseMS);
		    response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'distanceInCM', m3: ''});
		    if (!response.success) errorAlert();
		    if (response.m3 != 400) errorAlert();

			await pauseMilliseconds(pauseMS);
		    response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'windowBackgroundColor', m3: ''});
		    if (!response.success) errorAlert();
		    if (response.m3 != "FFFFE6") errorAlert();

			await pauseMilliseconds(pauseMS);
		    response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'acuityForeColor', m3: ''});
		    if (response.m3 != "000000") errorAlert();
		    response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'acuityForeColor', m3: 'FF0000'});
		    response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'acuityForeColor', m3: ''});
		    if (response.m3 != "FF0000") errorAlert();

			await pauseMilliseconds(pauseMS);
		    response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'acuityBackColor', m3: ''});
		    if (response.m3 != "FFFFFF") errorAlert();
		    response = await tellIframeReturningPromise({m1: 'setSetting', m2: 'acuityBackColor', m3: '0000FF'});
		    response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'acuityBackColor', m3: ''});
		    if (response.m3 != "0000FF") errorAlert();

			await pauseMilliseconds(pauseMS);
		    response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'gratingForeColor', m3: ''});
		    if (!response.success) errorAlert();
		    if (response.m3 != "AAAAAA") errorAlert();

			await pauseMilliseconds(pauseMS);
		    response = await tellIframeReturningPromise({m1: 'getSetting', m2: 'gratingBackColor', m3: ''});
		    if (!response.success) errorAlert();
		    if (response.m3 != "555555") errorAlert();

			await pauseMilliseconds(pauseMS);
		    sendAsyncMessageChain01();
		    //runResponding();
		}
		function errorAlert() {
			alert("error");
		}

		testAll();
    </script>

<h2>Test All &nbsp; <button onclick="testAll();">Start Testing</button><h2>

<h2>Test specific items</h2>
    <button onclick="tellIframe({m1: 'setFullScreen', m2: NO, m3: ''});">fullScreen NO</button>
    <button onclick="tellIframe({m1: 'setFullScreen', m2: YES, m3: ''});">fullScreen YES</button>
    <button onclick="tellIframe({m1: 'reload', m2: '', m3: ''});">reload</button>
    <button onclick="tellIframe('xx');">Send 'xx'</button>
    <button onclick="tellIframe({m1: 'm1', m2: 'm2', m3: 'm3'});">Send well formed, but unknown message</button>
    <br>
    <br>

    <button onclick="tellIframe({m1: 'getVersion', m2: '', m3: ''});">getVersion</button>
    <button onclick="tellIframe({m1: 'getSetting', m2: 'UNKNOWN', m3: ''});">getSetting UNKNOWN</button>
    <button onclick="tellIframe({m1: 'getSetting', m2: 'nTrials08', m3: ''});">getSetting nTrials08</button>
    <button onclick="tellIframe({m1: 'getSetting', m2: 'allKeys', m3: ''});">getSetting allKeys</button>
    <br>
    <br>

    <button onclick="tellIframe({m1: 'setSetting', m2: 'Preset', m3: 'NOTAPRESET'});">setSetting Preset NOTAPRESET</button>
    <button onclick="tellIframe({m1: 'setSetting', m2: 'Preset', m3: 'Standard Defaults'});">setSetting Preset Defaults</button>
    <button onclick="tellIframe({m1: 'setSetting', m2: 'Preset', m3: 'Testing'});">setSetting Preset Testing</button>
    <button onclick="tellIframe({m1: 'setSetting', m2: 'Preset', m3: 'Demo'});">setSetting Preset Demo</button>
    <br>

    <button onclick="tellIframe({m1: 'setSetting', m2: 'nTrials08', m3: '999'});">setSetting nTrials08: 999</button>
    <button onclick="tellIframe({m1: 'setSetting', m2: 'nTrials08', m3: '3'});">setSetting nTrials08: 3</button>
    <button onclick="tellIframe({m1: 'setSetting', m2: 'distanceInCM', m3: '57'});">setSetting distanceInCM: 57</button>
    <button onclick="tellIframe({m1: 'setSetting', m2: 'calBarLengthInMM', m3: '145'});">setSetting calBarLengthInMM: 145</button>
    <button onclick="tellIframe({m1: 'setSetting', m2: 'autoRunIndex', m3: '0'});">setSetting autoRunIndex: 0</button>
    <br>
    <br>

    <button onclick="tellIframe({m1: 'getValue', m2: 'isInRun', m3: ''});">getValue isInRun</button>
    <button onclick="tellIframe({m1: 'getValue', m2: 'iTrial', m3: ''});">getValue iTrial</button>
    <button onclick="tellIframe({m1: 'getValue', m2: 'currentAlternative', m3: ''});">getValue currentAlternative</button>
    <br>
    <br>

    <button onclick="tellIframe({m1: 'Run', m2: 'UNKNOWN2', m3: 'UNKNOWN3'});">Run UNKNOWN</button>
    <button onclick="tellIframe({m1: 'Run', m2: 'Acuity', m3: 'Letters'});">Run Acuity Letters</button>
    <button onclick="tellIframe({m1: 'Run', m2: 'Acuity', m3: 'LandoltC'});">Run Acuity LandoltC</button>
    <button onclick="tellIframe({m1: 'Run', m2: 'Contrast', m3: 'LandoltC'});">Run Contrast LandoltC</button>
    <button onclick="tellIframe({m1: 'Run', m2: 'TestNumber', m3: 3});">Run TestNumber 3</button>
    <br>
    <button onclick="runDemoWith3trials();">Run short Letters demo with only 3 trials</button>
    <br>
    <br>

    <button onclick="sendAsyncMessageChain01()">sendAsyncMessageChain: 12-trial demo run, then restore.</button>
    <button onclick="runResponding()">runResponding</button>
    <button onclick="tellIframe({m1: 'respondWithChar', m2: '2', m3: 3});">respond "2"</button>
    <button onclick="tellIframe({m1: 'respondWithChar', m2: '4', m3: 3});">respond "4"</button>
    <button onclick="tellIframe({m1: 'respondWithChar', m2: '6', m3: 3});">respond "6"</button>
    <button onclick="tellIframe({m1: 'respondWithChar', m2: '8', m3: 3});">respond "8"</button>
    <br>
    <br>

    <button onclick="tellIframe({m1: 'Unittest', m2: 'Error', m3: ''});">Unittest runtime error</button>
    <button onclick="tellIframe({m1: 'Unittest', m2: 'RewardImages', m3: ''});">Unittest RewardImages</button>
    <br>
    <br>
    <button onclick="tellIframe({m1: 'getSetting', m2: 'windowBackgroundColor', m3: ''});">get windowBackgroundColor</button>
    <button onclick="tellIframe({m1: 'setSetting', m2: 'windowBackgroundColor', m3: 'FF77FF'});">set windowBackgroundColor</button>
    <button onclick="tellIframe({m1: 'getSetting', m2: 'acuityForeColor', m3: ''});">get acuityForeColor</button>
    <button onclick="tellIframe({m1: 'setSetting', m2: 'acuityForeColor', m3: 'FF0000'});">set acuityForeColor RED</button>
    <button onclick="tellIframe({m1: 'getSetting', m2: 'acuityBackColor', m3: ''});">get acuityBackColor</button>
    <button onclick="tellIframe({m1: 'setSetting', m2: 'acuityBackColor', m3: '0000FF'});">set acuityBackColor BLUE</button>
    <button onclick="tellIframe({m1: 'setSetting', m2: 'gratingForeColor', m3: 'FF00FF'});">set gratingForeColor MAG.</button>
    <button onclick="tellIframe({m1: 'setSetting', m2: 'gratingBackColor', m3: '0000FF'});">set gratingBackColor BLUE</button>
	</body>
</html>
